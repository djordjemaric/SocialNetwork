image: maven:3.9.6-amazoncorretto-17



definitions:
  scripts:
    - script: &createOIDCscript
        - export AWS_REGION=eu-central-1
        - export AWS_ROLE_ARN=arn:aws:iam::211125711045:role/bitbucket_oidc_role
        - export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token
        - echo $BITBUCKET_STEP_OIDC_TOKEN > $(pwd)/web-identity-token
  steps:
    - step: &build
        name: Build the application
        caches:
          - maven
        script:
          - mvn -B clean package -DskipTests --file pom.xml
        artifacts:
          - target/*.jar
    - step: &testOIDC
        image: amazon/aws-cli
        name: Creating aws openID connection
        oidc: true
        script:
          - *createOIDCscript
          - aws sts get-caller-identity


pipelines:
  default:
    - step: *testOIDC
  branches:
    master:
      - step: *build
#      - step: *testOIDC
